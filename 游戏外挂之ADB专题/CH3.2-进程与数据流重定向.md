
# 凡哥OpenCV基础入门教程（跳一跳专题）-CH3.2-进程与数据流重定向

> 原创文章，转载请注明出处！！

> 本文为【凡哥原创教程】VIP教程节选，欢迎加入技术交流群了解会员制度（QQ：627671914）

## 0. 概要

我们需要在python中执行adb的命令行， 需要用到python的subprocess子进程模块。

而如果要理解程序， 大家还是需要稍稍补习一下操作系统中的一些基本概念， 例如进程与数据流重定向。期间我还以搬砖的例子类比了 指令,程序,进程的概念。

![pipe](http://image.myfange.com/20180328pipe1.png-bk)

## 1. 指令(instuction)

计算机指令， 其实是计算机做的最底层的工作。 例如一些算数运算， 逻辑运算等。一条指令通常由操作码与地址码组成。

计算机所有指令的集合， 我们称之为指令集(指令系统)。

不同的架构会采用不同的指令集， 常见的指令集`armv7`,`armv7s`,`arm64`,`i386`,`x86_64`

在搬砖的这个情况我们可以定义一个指令

```
移动砖 + 砖源地址 + 砖目的地址
```

## 2. 程序(program)

如程序是一组指令的集合完成某个特定的行为。我们平常用高级语言(例如C语言)写的代码`.C` 文件。 我们运行C程序的时候，会先将C代码编译成机器语言， 机器语言就是由一行一行的指令组成的。 我们平常说的汇编其实就是直接用机器语言写代码。

程序定义了一系列的过程。 在搬砖的例子里面， 我们创建了一个程序`搬多个砖`

```
传入参数： 砖源基地址，砖目的基地址， 砖的数量
for 砖序号 in range(砖数量):
	移动砖(砖源基地址+砖序号, 砖目的基地址+砖序号)
```

## 3. 进程(process)

进程是程序的具体实现。类似雇佣工人(分配资源，例如内存空间 )，按照搬砖规范(程序),去实现搬砖的这个过程。同一时间内，可以有多个人同时搬砖(并发)。 

也可以雇佣一个人， 让他搬好几次的砖。

## 4. 子进程(child process)

Unix/Linux操作系统提供了一个`fork()`系统调用，它非常特殊。Windows下是没有fork这个说法的。

普通的函数调用，调用一次，返回一次，但是`fork()`调用一次，返回两次，因为操作系统自动把当前进程（称为父进程）复制了一份（称为子进程），然后，分别在父进程和子进程内返回。

**子进程如果运行成功， 就会返回0， 如果是其他数值， 就代表程序出错**

## 5. python-subprocess

**Python里的subprocess虽然也可以翻译为子进程，但是非常不同， subproces用于执行外部命令**。

它是`os.fork()` 和 `os.execve()` 的封装. 启动的进程(subprocess)不会把父进程的模块加载一遍。

例如如果我们想在python程序中执行shell命令， 例如删除一个文件`rm demo.txt` 

这里我们就需要subprocess模块。

下节课， 凡哥会详细介绍subprocess模块的使用方法。

## 6. 数据流(stream)

关于linux中的数据流 凡哥没有找到很多确切的介绍， 百度百科里有如下介绍：

数据流（data stream）最初是通信领域使用的概念，代表传输中所使用的信息的数字编码信号序列。然而，我们所提到的数据流概念与此不同。这个概念最初在1998年由Henzinger在文献87中提出，他将数据流定义为**只能以事先规定好的顺序被读取一次的数据的一个序列**。

流根据格式的不同可以为两种， 一种是字节流， 另外一种是字符流。

根据数据流向的不同， 可以分为输入流跟输出流。

## 7. 数据流重定向

在linux中， 运行一个程序会默认打开三个数据流

* stdin 标准输入流 standard input stream
* stdout 标准输出 standard ouput stream
* stderr 标准错误流

当Unix执行一个程序的时候，会自动打开三个流，标准输入(standard input)，标准输出(standard output)，标准错误(standard error)。比如说你打开命令行的时候，默认情况下，命令行的标准输入连接到键盘，标准输出和标准错误都连接到屏幕。对于一个程序来说，尽管它总会打开这三个流，但它会根据需要使用，并不是一定要使用。



之前在linux的教程里有提到过数据流向的标识`<` 与`>`.

这里我们再详细介绍一下。

### 7.1 标准输入流(stdin)

`<` 代表标准输入流。

例如`cat`指令主要用作文件显示与整合。数据流来自`output.txt`,  通过标准数据流，导向cat, cat程序的默认输出流是屏幕，所以你就可以在屏幕上看到output的内容。

```bash
cat < ouput.txt
```

### 7.2 标准输出流(stdout)

如果程序正确执行，产生的数据会导向标准输出流。

之前讲过，标准输出流默认指向屏幕。

我们查看文件列表的时候使用ls指令。

```
ls
```

ls程序正确执行，打印文件列表信息到屏幕。

我们可以使用`>` 来指定输出流。

```
ls > output.txt
```

首先会在本地新建一个文件`output.txt` (如果文件已存在就覆盖)

然后ls执行，标准输出流导向`output.txt`

另外标准输出流操作符还有另外一种`>>`， 每次执行的时候不会创建新的文件，而是在文件末尾追加。

```
ls >> output.txt # 重新定向标准输出， 附加在末尾
```

### 7.3 标准错误输出流stderr

如果程序在运行过程中出现错误， 程序意外退出。报错信息就会通过标准错误输出流输出。

如果我们利用`cd` 打开一个不存在的会件夹，那么就会报错。

我们可以使用`2>` 来指定错误输出流的输出。

```bash
cd folder_not_exist 2> error_log.txt
```

我们也可以将标准输出流与错误输出流导向同一个位置

```bash
cd folder_not_exist >& error_log.txt
```

## 8. 管道pipe

上面我们介绍了进程的概念。 有时候进程之间需要通信。 一个进程的输出可以作为另外一个进程的输入， 这里我们就需要借助各种通信机制。

在linux下的多个进程间的通信机制叫做IPC(Inter-Process Communication).

IPC也有很多种, 例如：

* 半双工管道
* 命名管道
* 消息队列
* 信号
* 信号量
* 共享内存
* 共享映射文件
* 套接字 socket

这里我们仅简介一下管道。

管道的原理就是使用一块共享内存， 组成环形区域，通过共享内存区域实现进程间的通信。

管道是半双工的， 数据流向是单方向的，进程A向管道中写入数据， 进程B从管道中读取数据。 如果要实现进程A与进程B的双向通信， 则我们需要两个管道。

在linux中管道的标识符是`|`.

管道符左边命令的输出就会作为管道符右边命令的输入。连续使用管道意味着第一个命令的输出会作为 第二个命令的输入，第二个命令的输出又会作为第三个命令的输入，依此类推。

这里我们再引入另外一个命令`wc` world count 用于统计字符个数。

```
wc demo.txt
```

输出结果：

```
 7     8     70     demo.txt
```

分别代表 ： 行数 单词数 字节数 文件名

我们执行命令行：

```
cat < demo.txt | wc 
```

数据流从`demo.txt` 读入， 作为标准输入提供给`cat`,  cat 将标准输出数据流通过管道作为`wc` 对应进程的标准输入， 完成计数工作。

##  9. Reference

[多进程 - 廖雪峰的官方网站](https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/0013868323401155ceb3db1e2044f80b974b469eb06cb43000) 

[Vamei-Linux文本流](http://www.cnblogs.com/vamei/archive/2012/09/14/2683756.html)

[Linux 数据流重定向](http://www.cnblogs.com/shijingjing07/p/5632768.html) 

[linux基础——linux进程间通信（IPC）机制总结](http://blog.csdn.net/a987073381/article/details/52006729)

[子进程创建与使用subprocess](http://www.cnblogs.com/franknihao/p/6537159.html) 

[python subprocess 和 multiprocess选择以及我遇到的坑 - 彭玉松 - 博客园](https://www.cnblogs.com/pengyusong/p/6113148.html)    

[linux 中 ‘|’的作用是什么？](https://zhidao.baidu.com/question/556066419.html)

[Linux cat命令详解 - Danny Chen - 博客园](https://www.cnblogs.com/zhangchenliang/p/7717602.html)

![](http://image.myfange.com/微信公众号底部.png-bk)